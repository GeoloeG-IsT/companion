<!-- Generated by agents-reverse-engineer -->

# web/server

**Bun-powered HTTP/WebSocket bridge server mediating between browser clients and Claude Code/Codex CLI backends, managing session lifecycle, git worktree isolation, environment profiles, and persistent state.**

## Contents

### Core Bridge

- **[ws-bridge.ts](./ws-bridge.ts)** — Central message router orchestrating WebSocket communication between browser clients, Claude Code CLI (NDJSON), and Codex adapters (JSON-RPC stdio). Maintains per-session `messageHistory`, `pendingPermissions`, `state` snapshots, and delegates persistence to SessionStore. Handles stream events, permission requests, tool progress, auto-naming triggers, and backend reconnection.

- **[index.ts](./index.ts)** — Server bootstrap entrypoint on port 3456. Wires together WsBridge, CliLauncher, SessionStore, WorktreeTracker. Serves production frontend from `dist/`. Upgrades HTTP requests matching `/ws/cli/:id` and `/ws/browser/:id` to WebSocket connections with discriminated `SocketData`. Implements 10s reconnection grace period for restored sessions and invokes auto-naming after first completed turn.

- **[routes.ts](./routes.ts)** — Hono REST API for session CRUD (`POST /sessions/create`, `GET /sessions`, `PATCH /sessions/:id/name`, `POST /sessions/:id/kill`, `DELETE /sessions/:id`), filesystem browsing (`GET /fs/list`, `GET /fs/tree`, `PUT /fs/write`, `GET /fs/diff`), git operations (`GET /git/repo-info`, `POST /git/worktree`, `DELETE /git/worktree`, `POST /git/fetch`, `POST /git/pull`), environment profiles (`GET /envs`, `POST /envs`, `PUT /envs/:slug`, `DELETE /envs/:slug`), backend discovery (`GET /backends`, `GET /backends/:id/models`), and usage limits (`GET /usage-limits`, `GET /sessions/:id/usage-limits`). Integrates worktree cleanup with shared-worktree safety checks.

### Backend Adapters

- **[cli-launcher.ts](./cli-launcher.ts)** — Lifecycle manager for Claude Code (`--sdk-url` WebSocket) and Codex (`app-server` stdio) subprocesses. Spawns sessions via `launch()`, relaunches with `--resume <cliSessionId>` for Claude or fresh Codex adapter initialization, kills processes with SIGTERM/SIGKILL cascades, persists `SdkSessionInfo` to disk via SessionStore. Injects git worktree guardrails as markdown section in `.claude/CLAUDE.md` to enforce branch isolation rules.

- **[codex-adapter.ts](./codex-adapter.ts)** — Protocol translator bridging Codex `app-server` JSON-RPC (stdin/stdout) to Vibe Companion's `BrowserIncomingMessage`/`BrowserOutgoingMessage` types. Implements `JsonRpcTransport` for NDJSON request/response matching, handles `item/started`, `item/agentMessage/delta`, `item/completed`, `turn/completed` notifications to emit stream events, tool use/result messages, and result summaries. Maps approval flows: `item/commandExecution/requestApproval` → Bash permission, `item/fileChange/requestApproval` → Edit permission, `item/tool/requestUserInput` → AskUserQuestion format. Caches rate limits via `account/rateLimits/updated`.

### Session Management

- **[session-types.ts](./session-types.ts)** — All TypeScript interfaces for WebSocket protocol: `CLIMessage` union (system init/status, assistant, result, stream_event, control_request, tool_progress, auth_status), `BrowserIncomingMessage` union (session_init, session_update, assistant, result, permission_request, stream_event), `BrowserOutgoingMessage` union (user_message, permission_response, interrupt, set_model), `SessionState` (model, cwd, tools, permissionMode, git_branch, total_cost_usd, context_used_percent), `PermissionRequest`, `PermissionUpdate` union (addRules, replaceRules, setMode, addDirectories), `ContentBlock` union (text, tool_use, tool_result, thinking).

- **[session-store.ts](./session-store.ts)** — File-based persistence to `$TMPDIR/vibe-sessions/`. Exports `SessionStore` class with `save()` (debounced 150ms for stream events), `saveSync()` (immediate for critical state), `load()`, `loadAll()`, `setArchived()`, `remove()`. Persists `PersistedSession` with `id`, `state`, `messageHistory`, `pendingMessages`, `pendingPermissions` as JSON files. Launcher state stored separately as `launcher.json`.

- **[session-names.ts](./session-names.ts)** — Lazy-loaded persistent mapping from session IDs to human-readable names, stored at `~/.companion/session-names.json`. Exports `getName()`, `setName()`, `getAllNames()`, `removeName()`. Immediate persistence on mutation via `persist()` with JSON pretty-printing.

- **[auto-namer.ts](./auto-namer.ts)** — Spawns one-shot CLI processes to generate 3-5 word session titles from first user message. Exports `generateSessionTitle()` which delegates to `generateTitleViaClaude()` (spawns `claude -p PROMPT --model MODEL --output-format json`) or `generateTitleViaCodex()` (spawns `codex exec -q PROMPT --model MODEL --json`, parses JSONL for last `agent_message` item). Resolves binary paths via `resolveClaudeBinary()`, `resolveCodexBinary()` with memoization. 15s timeout, quote stripping via `/^["']|["']$/g`, 100-char length validation.

### Git and Worktree Management

- **[git-utils.ts](./git-utils.ts)** — Git repository introspection and worktree management. Exports `getRepoInfo()` (repoRoot, currentBranch, defaultBranch, isWorktree), `listBranches()` (enriches with worktree mappings and ahead/behind counts via `git rev-list --left-right --count`), `listWorktrees()` (parses `git worktree list --porcelain`), `ensureWorktree()` (reuses or creates worktrees with unique `-wt-{random4digit}` branch suffixes for concurrent sessions on same branch), `removeWorktree()` (prunes, checks dirty status, deletes branch if companion-managed), `gitFetch()`, `gitPull()`, `checkoutBranch()`. All git commands use 10s timeout, worktree paths resolve to `~/.companion/worktrees/{repoName}/{sanitizedBranch}`.

- **[worktree-tracker.ts](./worktree-tracker.ts)** — Persistent registry mapping session IDs to git worktree paths, stored as JSON at `~/.companion/worktrees.json`. Exports `WorktreeTracker` class with `addMapping()`, `removeBySession()`, `getBySession()`, `getSessionsForWorktree()`, `isWorktreeInUse()`. `WorktreeMapping` captures `sessionId`, `repoRoot`, `branch` (conceptual user-selected branch), `actualBranch` (actual git branch name for `-wt-N` suffixed branches), `worktreePath`, `createdAt`.

### Environment and Usage

- **[env-manager.ts](./env-manager.ts)** — CRUD for named environment variable profiles stored at `~/.companion/envs/{slug}.json`. Exports `listEnvs()`, `getEnv(slug)`, `createEnv(name, variables)`, `updateEnv(slug, updates)`, `deleteEnv(slug)`. `CompanionEnv` interface: `name`, `slug` (via `slugify()`: lowercase, hyphens for whitespace, strip non-alphanumeric), `variables: Record<string, string>`, `createdAt`, `updatedAt`. Slug collision detection on create/update.

- **[usage-limits.ts](./usage-limits.ts)** — Fetches and caches Claude Code OAuth usage limits from `https://api.anthropic.com/api/oauth/usage` with 60s in-memory cache. Exports `getUsageLimits()` (main entry point), `getCredentials()`, `fetchUsageLimits(token)`. Refreshes expired tokens via `refreshAccessToken()` posting to `https://platform.claude.com/v1/oauth/token` with `grant_type=refresh_token`. Reads/writes credentials from macOS Keychain (`security find-generic-password -s "Claude Code-credentials"`) or Windows (`~/.claude/.credentials.json`). Returns `UsageLimits` with `five_hour`, `seven_day`, `extra_usage` (each nullable with `utilization`, `resets_at`).

## Architecture

### Data Flow

Browser clients connect via `/ws/browser/:id`, CLI processes connect via `/ws/cli/:id`, Codex adapters communicate over stdio. WsBridge maintains session registry, routing NDJSON from CLI to JSON for browsers, and vice versa. CliLauncher spawns/kills processes, stores PIDs and state in SessionStore. Auto-naming callback in index.ts invokes auto-namer after first completed turn. Git worktree guardrails injected by CliLauncher on session creation when `worktreeInfo` present.

### Session Lifecycle

1. `POST /sessions/create` → `launcher.launch()` → spawns CLI or Codex adapter
2. CLI WebSocket handshake → `wsBridge.handleCLIOpen()` → `launcher.markConnected()`
3. Browser reconnection → `wsBridge.handleBrowserOpen()` → replays `messageHistory`, sends pending permissions
4. Server restart → `launcher.restoreFromDisk()` + `wsBridge.restoreFromDisk()` → 10s grace period → relaunch stale sessions
5. `DELETE /sessions/:id` → kill process, cleanup worktree if exclusive, remove from store

### Worktree Isolation

Routes use WorktreeTracker to map sessions to worktrees. `ensureWorktree()` generates unique branch names (`{branch}-wt-{random4digit}`) when reusing worktree for same conceptual branch. Cleanup checks `isWorktreeInUse()` before removing worktree and optionally deletes companion-managed branches. Guardrails markdown forbids `git checkout/switch`, suggests `git show other-branch:path` for cross-branch references.

## Behavioral Contracts

### NDJSON Protocol

CLI messages delimited by `\n`. WsBridge splits on newlines, parses each line independently. CLI-bound messages from `sendToCLI()` append `\n` delimiter. Codex adapter uses identical newline-delimited JSON-RPC over stdin/stdout via `JsonRpcTransport`.

### Git Commands

- `git rev-parse --abbrev-ref HEAD` — current branch
- `git rev-parse --git-dir` — worktree detection (checks for `/worktrees/` substring)
- `git rev-parse --show-toplevel` — repo root
- `git rev-list --left-right --count origin/{branch}...{branch}` → `{behind} {ahead}`
- `git for-each-ref refs/heads/ --format '%(refname:short)|%(worktreepath)'` — local branches
- `git for-each-ref refs/remotes/origin/ --format '%(refname:short)|%(worktreepath)'` — remote branches
- `git worktree list --porcelain` — parses lines prefixed `worktree `, `HEAD `, `branch `, `bare`
- `git worktree add -b {branch} "{path}" {base}` — create worktree

All execSync calls use `timeout: 10_000` ms except usage-limits (5000ms), env-manager (none), routes (3000–5000ms).

### Auto-Naming Prompt Template

```
Generate a concise 3-5 word session title for this user request. Output ONLY the title, nothing else.

Request: ${first500chars}
```

Claude backend: `claude -p PROMPT --model MODEL --output-format json`, extracts `parsed.result`.  
Codex backend: `codex exec -q PROMPT --model MODEL --json`, parses JSONL for last `item.type === "agentMessage"` with `item.completed`, extracts `item.text`.

Both strip quotes via regex `/^["']|["']$/g`, validate length < 100 characters, 15s timeout.

### Permission Flow

1. CLI sends `control_request` (subtype `can_use_tool`) → WsBridge stores in `pendingPermissions` map → broadcast `permission_request` to browsers
2. Browser sends `permission_response` → WsBridge removes from map → sends `control_response` to CLI with `behavior: "allow"` or `behavior: "deny"`
3. Codex: `item/commandExecution/requestApproval` → stores JSON-RPC id → `PermissionRequest` → browser response → `{ decision: "accept" | "decline" }` JSON-RPC response

### Context Usage Calculation

`Math.round(((inputTokens + outputTokens) / contextWindow) * 100)` clamped to `[0, 100]`. Extracted from `msg.modelUsage[model].inputTokens`, `msg.modelUsage[model].outputTokens`, `msg.modelUsage[model].modelContextWindow` in result messages.

### Worktree Guardrails Injection

Markers: `<!-- WORKTREE_GUARDRAILS_START -->` and `<!-- WORKTREE_GUARDRAILS_END -->`. Only injects when `worktreePath !== repoRoot` and `existsSync(worktreePath)`. Content includes branch label (with `parentBranch` if provided), main repo path, rules forbidding `git checkout/switch`, enforcing commits to current branch only. Written to `.claude/CLAUDE.md` in worktree, replacing existing section or appending.

## Import Map

- `../generation/writers/sum.js` — not referenced
- `./session-types.js` — imported by ws-bridge, routes, cli-launcher, codex-adapter
- `./session-store.js` — imported by index, cli-launcher, ws-bridge, routes
- `./codex-adapter.ts` — imported by cli-launcher, index (via onCodexAdapterCreated callback)
- `./env-manager.ts` — imported by routes
- `./git-utils.ts` — imported by routes
- `./session-names.ts` — imported by index, routes
- `./worktree-tracker.ts` — imported by index, routes
- `./usage-limits.ts` — imported by routes
- `./auto-namer.ts` — imported by index