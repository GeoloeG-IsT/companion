<!-- Generated by agents-reverse-engineer -->

# web

The Vibe Companion web application — a monorepo workspace containing Bun+Hono backend server, React 19 frontend, and CLI entry point. Orchestrates protocol translation between browser WebSockets and Claude Code/Codex CLI backends, manages session persistence, git worktree isolation, and environment profiles.

## Stack

**Runtime**: Bun 1.0+  
**Backend**: Hono 4.7 (WebSocket+REST on port 3456)  
**Frontend**: React 19 + Vite 6.3 (dev server on port 5174, production assets served from `dist/`)  
**State**: Zustand 5.0 (client-side session store)  
**Persistence**: JSON files (`$TMPDIR/vibe-sessions/`, `~/.companion/`, macOS Keychain)  
**Testing**: Vitest 4.0 with jsdom for React components, Node.js for server  
**CLI**: Published as `the-vibe-companion` via `bin/cli.ts`

## Contents

### Configuration

- [package.json](./package.json) — Package manifest defining name `the-vibe-companion`, version `0.17.1`, bin entry point `./bin/cli.ts`, scripts for `dev`/`build`/`start`/`test`, runtime dependencies (hono), devDependencies (React 19, Vite, Zustand, CodeMirror, xterm.js, vitest, tailwindcss), `engines.bun: ">=1.0.0"`, `files: ["bin/", "server/", "dist/"]` for npm publish.

- [tsconfig.json](./tsconfig.json) — TypeScript config targeting ES2022 with `jsx: "react-jsx"`, `moduleResolution: "bundler"`, `strict: true`, `noEmit: true`, `types: ["vitest/globals"]`, includes both `src/` and `server/` directories.

- [vite.config.ts](./vite.config.ts) — Vite bundler config with `react()` and `tailwindcss()` plugins, dev server on port 5174 bound to `"0.0.0.0"`, proxies `/api` and `/ws` to backend `http://localhost:3456`.

- [vitest.config.ts](./vitest.config.ts) — Vitest test runner with `globals: true`, default environment `"node"`, `environmentMatchGlobs` mapping `src/**/*.test.ts` and `src/**/*.test.tsx` to jsdom, `setupFiles: ["src/test-setup.ts"]`.

### Development Tooling

- [dev.ts](./dev.ts) — Parallel dev server orchestrator spawning two Bun subprocesses: backend (`bun --watch server/index.ts` with cyan `[backend]` prefix) and vite (`bun run dev:vite` with magenta `[vite]` prefix). Multiplexes stdout/stderr via `prefix()` reader, registers `SIGINT`/`SIGTERM` cleanup, races process exit for immediate shutdown.

### Documentation

- [CODEX_MAPPING.md](./CODEX_MAPPING.md) — Protocol translation spec mapping Codex JSON-RPC 2.0 stdio messages (`item/started`, `item/agentMessage/delta`, `item/completed`, `turn/completed`, approval request methods) to Vibe Companion browser WebSocket types (`stream_event`, `assistant`, `tool_use`, `tool_result`, `permission_request`, `CLIResultMessage`). Documents `mapApprovalPolicy()` conversion (bypassPermissions → `"never"`, acceptEdits → `"untrusted"`, plan → `"untrusted"`), `initialize`/`thread/start`/`thread/resume` lifecycle, item type mappings (agentMessage, commandExecution, fileChange, mcpToolCall, webSearch, reasoning, contextCompaction), known limitations (token usage hardcoded to 0, no runtime model/permission switching, MCP/WebSearch approval auto-accepted).

## Subdirectories

- [bin/](./bin/) — CLI entry point `cli.ts` setting `__VIBE_PACKAGE_ROOT` and `NODE_ENV` before importing `server/index.ts`. Maps package.json `bin.the-vibe-companion` to this shebang script for `bunx` invocation.

- [server/](./server/) — Bun+Hono backend with `index.ts` bootstrap, `ws-bridge.ts` message router, `cli-launcher.ts` subprocess manager, `codex-adapter.ts` JSON-RPC translator, `session-store.ts` file persistence, `routes.ts` REST API, `git-utils.ts`/`worktree-tracker.ts` for git worktree isolation, `env-manager.ts` for environment profiles, `usage-limits.ts` OAuth token refresh, `auto-namer.ts` LLM-powered session titling, `session-types.ts` protocol definitions.

- [src/](./src/) — React 19 frontend with `App.tsx` root layout (hash routing, three-column grid), `store.ts` Zustand session state (40+ actions, localStorage persistence), `ws.ts` WebSocket client with NDJSON parsing and task extraction, `api.ts` REST client, `types.ts` shared type exports. Subdirectories: `components/` (ChatView, MessageFeed, Composer, Sidebar, TaskPanel, ToolBlock, EditorPanel, Playground, EnvManager), `utils/` (backends, names, notification-sound, recent-dirs).

## Architecture

### Data Flow

```
Browser React App (:5174 dev, dist/ prod)
  ↓ WebSocket /ws/browser/:id
Hono Server (:3456)
  ├→ ws-bridge.ts (message router, session state)
  ├→ cli-launcher.ts → Claude Code CLI (--sdk-url ws://localhost:3456/ws/cli/:id)
  └→ codex-adapter.ts → Codex app-server (stdio JSON-RPC)
```

Frontend connects per session via `ws.ts` to `/ws/browser/:id`. Backend upgrades HTTP requests to WebSocket based on URL pattern (`/ws/cli/:id` for CLI processes, `/ws/browser/:id` for browsers) with discriminated `SocketData`. `ws-bridge.ts` maintains `SessionContext` with `messageHistory`, `pendingPermissions`, `state`, `codexAdapter`, delegates to `CliLauncher` for process lifecycle, `SessionStore` for disk persistence.

### Backend Selection

Routes expose `GET /api/backends` returning array of `{id: "claude-code" | "codex", name, available}`. Frontend `api.getBackends()` populates backend selector in `HomePage`. Session creation sends `backend: BackendType` to `POST /api/sessions/create`, `CliLauncher.launch()` branches on backend: spawns `claude` with `--sdk-url` for Claude Code, spawns `codex app-server` and creates `CodexAdapter` for Codex. All WsBridge message routing is backend-agnostic after adapter creation.

### Session Persistence

`SessionStore` writes debounced JSON to `$TMPDIR/vibe-sessions/{sessionId}.json` (150ms for stream events, immediate for critical state via `saveSync()`). Persisted fields: `id`, `state` (model, cwd, tools, permissionMode, git_branch, cost, context), `messageHistory` (full `BrowserIncomingMessage[]`), `pendingMessages` (queued while CLI disconnected), `pendingPermissions` (Map→Array serialization). On server restart, `WsBridge.restoreFromDisk()` rehydrates state, `CliLauncher.restoreFromDisk()` detects stale PIDs via 10s grace period, relaunches with `--resume <cliSessionId>` for Claude Code or fresh adapter for Codex.

### Git Worktree Isolation

`git-utils.ts` exports `ensureWorktree(repoRoot, branch)` creating unique worktree paths at `~/.companion/worktrees/{repoName}/{sanitizedBranch}`, generates `-wt-{random4digit}` branch suffixes for concurrent sessions on same branch. `WorktreeTracker` persists session-to-worktree mappings at `~/.companion/worktrees.json`. `CliLauncher.launch()` injects markdown guardrails into `.claude/CLAUDE.md` when `worktreeInfo` provided, forbidding `git checkout/switch`, enforcing commits to current branch. Routes expose `POST /api/git/worktree`, `DELETE /api/git/worktree` with shared-worktree safety checks via `isWorktreeInUse()`.

### Environment Profiles

`EnvManager` stores named variable sets at `~/.companion/envs/{slug}.json` with interface `{name, slug, variables: Record<string,string>, createdAt, updatedAt}`. Slug generation via `slugify()`: lowercase, replace whitespace with hyphens, strip non-alphanumeric. Routes expose CRUD endpoints: `GET /envs`, `POST /envs`, `PUT /envs/:slug`, `DELETE /envs/:slug`. `HomePage` component consumes via `api.listEnvs()`, `api.createEnv()`, displays `EnvManager` modal with key-value editor.

### Auto-Naming Pipeline

On session creation, `index.ts` registers callback with `WsBridge` to invoke `auto-namer.ts` after first completed turn. `generateSessionTitle()` extracts first 500 chars of user message, spawns one-shot CLI process: `claude -p PROMPT --model MODEL --output-format json` for Claude backend (parses `result` field), `codex exec -q PROMPT --model MODEL --json` for Codex backend (parses JSONL for last `agentMessage` item). Strips quotes via `/^["']|["']$/g`, validates length < 100, persists via `SessionNames.setName()`, broadcasts update to browsers. 15s timeout, logged warnings on failure.

### Task Extraction

`ws.ts` parses all `assistant` messages for `tool_use` blocks named `TodoWrite`, `TaskCreate`, `TaskUpdate`. `extractTasksFromBlocks()` logic:
- **TodoWrite**: replaces entire task list, renumbers IDs starting from 1
- **TaskCreate**: increments per-session counter, builds `TaskItem` with generated ID
- **TaskUpdate**: extracts `taskId` from `input`, applies partial update (status, owner, activeForm, blockedBy)

Deduplicates via `processedToolUseIds` Map. `TaskPanel` subscribes to `sessionTasks.get(sessionId)`, renders `TaskRow` with status icons (spinner/checkmark/circle), filters by owner/status.

## Structure

Top-level `web/` contains config files (`package.json`, `tsconfig.json`, `vite.config.ts`, `vitest.config.ts`), dev orchestrator (`dev.ts`), documentation (`CODEX_MAPPING.md`). Three subdirectories: `bin/` (CLI shim), `server/` (Hono backend modules), `src/` (React frontend source). All TypeScript code in `server/` and `src/` covered by single `tsconfig.json` with bundler module resolution. Tests colocated with source (`routes.test.ts`, `codex-adapter.test.ts`) or in `src/__tests__/`, environment selected via vitest `environmentMatchGlobs`.

## Behavioral Contracts

### NDJSON Protocol

CLI processes write newline-delimited JSON to WebSocket. `WsBridge.handleCLIMessage()` splits `data` on `\n`, parses each line via `JSON.parse()`. Codex adapter uses identical newline-delimited JSON-RPC over stdin/stdout via `JsonRpcTransport.send()` (appends `\n`), `.onData()` (splits on `\n`). Browser WebSockets receive typed JSON messages without delimiters.

### Git Command Patterns

All git operations in `git-utils.ts` use `execSync` with `timeout: 10_000` ms:
- `git rev-parse --abbrev-ref HEAD` → current branch
- `git rev-parse --show-toplevel` → repo root
- `git rev-parse --git-dir` → worktree detection (checks `/worktrees/` substring)
- `git worktree list --porcelain` → parses lines prefixed `worktree `, `HEAD `, `branch `
- `git worktree add -b {branch} "{path}" {base}` → create worktree
- `git rev-list --left-right --count origin/{branch}...{branch}` → ahead/behind counts

Worktree paths sanitized via `sanitizeBranchName()`: replace `/` with `_`, collapse multiple underscores.

### Auto-Naming Prompt Template

```
Generate a concise 3-5 word session title for this user request. Output ONLY the title, nothing else.

Request: ${first500chars}
```

Claude backend: `claude -p PROMPT --model MODEL --output-format json`, extracts `parsed.result`.  
Codex backend: `codex exec -q PROMPT --model MODEL --json`, parses JSONL for last `item.type === "agentMessage"` with `item.completed`, extracts `item.text`.

### Permission Request Flow

Claude Code: CLI sends `control_request` (subtype `can_use_tool`) → WsBridge stores in `pendingPermissions` Map → broadcasts `permission_request` to browsers → user responds → WsBridge sends `control_response` (behavior `"allow"` or `"deny"`).

Codex: adapter receives `item/commandExecution/requestApproval` or `item/fileChange/requestApproval` JSON-RPC request → stores request ID → synthesizes `permission_request` → user responds → sends JSON-RPC response `{decision: "accept" | "decline"}`.

### WebSocket Reconnection

Browser: `ws.ts` registers `onclose` handler calling `scheduleReconnect(sessionId)` after 2000ms. Checks if session archived in `sdkSessions` before reconnecting. Clears timeout on `onopen`.

CLI: On disconnect, WsBridge stores pending messages in `pendingMessages[]`, waits 10s grace period. If CLI reconnects (server restart case), replays queue. If timeout expires, `CliLauncher.relaunchSession()` kills stale PID, spawns with `--resume <cliSessionId>`.

### LocalStorage Persistence

`store.ts` subscribes to Zustand state changes, writes to localStorage:
- `cc-session-names` → JSON array of `[sessionId, name]` tuples
- `cc-current-session` → active session ID string
- `cc-dark-mode` → `"true"` or `"false"`
- `cc-notification-sound` → `"true"` or `"false"`

`utils/recent-dirs.ts` persists LRU cache to `cc-recent-dirs` (max 5 entries).

### Context Usage Calculation

Extracted from `result` messages: `Math.round(((inputTokens + outputTokens) / contextWindow) * 100)` clamped to `[0, 100]`. Reads `msg.modelUsage[model].inputTokens`, `msg.modelUsage[model].outputTokens`, `msg.modelUsage[model].modelContextWindow`.

## File Relationships

`dev.ts` spawns `server/index.ts` and vite, orchestrates shutdown. `bin/cli.ts` imports `server/index.ts` for production execution. `server/index.ts` wires together `WsBridge`, `CliLauncher`, `SessionStore`, `WorktreeTracker`, registers routes from `routes.ts`, serves `dist/` when `NODE_ENV=production`. `server/ws-bridge.ts` delegates subprocess lifecycle to `cli-launcher.ts`, message translation to `codex-adapter.ts`, persistence to `session-store.ts`. `src/App.tsx` imports `ws.ts` for WebSocket management, `api.ts` for REST calls, `store.ts` for state subscriptions. All components in `src/components/` consume `store.ts` via `useStore` selectors, call `api.ts` functions, send messages via `sendToSession` from `ws.ts`. `src/types.ts` re-exports `server/session-types.ts` for shared protocol definitions across client and server.