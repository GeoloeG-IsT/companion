<!-- Generated by agents-reverse-engineer -->

# web/src

React 19 frontend implementing the browser UI for The Vibe Companion, managing multi-session Claude Code interactions via WebSocket and REST API.

## Contents

### Application Bootstrap

- [main.tsx](./main.tsx) — Mounts `App` into `#root` via `createRoot`, wraps with `StrictMode`, imports global styles from `index.css`.

- [App.tsx](./App.tsx) — Root component with hash-based routing (`useHash` via `useSyncExternalStore` on `hashchange`), renders three-column layout (Sidebar, main content, TaskPanel), switches between `ChatView`/`EditorPanel` via `activeTab`, shows `Playground` when hash equals `#/playground`, auto-connects restored sessions on mount via `connectSession`, syncs dark mode with `document.documentElement.classList`.

### State Management

- [store.ts](./store.ts) — Zustand store exporting `useStore` with session-keyed state: `sessions` (Map<string, SessionState>), `messages` (Map<string, ChatMessage[]>), `pendingPermissions` (Map<string, Map<string, PermissionRequest>>), `sessionTasks` (Map<string, TaskItem[]>), `streaming` (Map<string, string>), `changedFiles` (Map<string, Set<string>>), `connectionStatus`, `cliConnected`, `sessionStatus`, `editorOpenFile`, `editorUrl`, `editorLoading`, plus global UI state (`darkMode`, `sidebarOpen`, `taskPanelOpen`, `homeResetKey`, `activeTab`). Persists `sessionNames`, `currentSessionId`, `darkMode`, `notificationSound` to localStorage keys `cc-session-names`, `cc-current-session`, `cc-dark-mode`, `cc-notification-sound`. Exports 40+ actions including `appendMessage`, `setStreaming`, `addPermission`, `addTask`, `setSessionName`, `setConnectionStatus`, `setEditorOpenFile`, `removeSession` (cascades cleanup across 16 state maps).

### WebSocket Integration

- [ws.ts](./ws.ts) — Manages per-session WebSocket connections to `/ws/browser/:sessionId`, handles NDJSON message types (`session_init`, `assistant`, `stream_event`, `result`, `permission_request`, `status_change`, `cli_disconnected`, `message_history`). Exports `connectSession`, `disconnectSession`, `waitForConnection`, `sendToSession` for outgoing `BrowserOutgoingMessage`. Extracts tasks via `extractTasksFromBlocks` (parses `TodoWrite`, `TaskCreate`, `TaskUpdate` tool_use inputs), changed files via `extractChangedFilesFromBlocks` (Edit/Write inputs), deduplicates via `processedToolUseIds` Map, calls `playNotificationSound()` on result when document unfocused, schedules reconnect after 2000ms on WebSocket close.

### API Client

- [api.ts](./api.ts) — REST client exporting session CRUD (`createSession`, `listSessions`, `killSession`, `deleteSession`, `relaunchSession`, `archiveSession`, `renameSession`), filesystem ops (`listDirs`, `getFileTree`, `readFile`, `writeFile`, `getFileDiff`), Git worktree management (`getRepoInfo`, `listBranches`, `createWorktree`, `removeWorktree`, `gitFetch`, `gitPull`), environment profiles (`listEnvs`, `createEnv`, `updateEnv`, `deleteEnv`), backend config (`getBackends`, `getBackendModels`), usage limits (`getUsageLimits`, `getSessionUsageLimits`). All methods use internal helpers `post`, `get`, `put`, `patch`, `del` with JSON serialization, throws on non-ok HTTP responses with error message extraction.

### Type Definitions

- [types.ts](./types.ts) — Re-exports server types (`SessionState`, `PermissionRequest`, `ContentBlock`, `BrowserIncomingMessage`, `BrowserOutgoingMessage`, `BackendType`) from `../server/session-types.js`, defines client-only interfaces `ChatMessage` (with `role`, `contentBlocks`, `images`, `parentToolUseId`, `isStreaming`, `model`, `stopReason`), `TaskItem` (with `subject`, `activeForm`, `status`, `owner`, `blockedBy`), `SdkSessionInfo` (extends server session metadata with `archived`, `isWorktree`, `repoRoot`, `branch`, `actualBranch`, `gitAhead`, `gitBehind`, `totalLinesAdded`, `totalLinesRemoved`).

## Subdirectories

- [components/](./components/) — UI components including `ChatView`, `MessageFeed`, `MessageBubble`, `Composer`, `Sidebar`, `TopBar`, `TaskPanel`, `PermissionBanner`, `ToolBlock`, `HomePage`, `EditorPanel`, `Playground`, `FolderPicker`, `EnvManager`. Implements message grouping (`groupMessages`, `groupToolMessages`), slash command autocomplete, Git integration, permission displays for Bash/Edit/Write/Read/Glob/Grep/ExitPlanMode/AskUserQuestion, usage limits with countdown timers, auto-save with 800ms debounce, CodeMirror editor with diff view.

- [utils/](./utils/) — Helpers for backend/model configuration (`backends.ts` with `getModelsForBackend`, `CLAUDE_MODES`, `CODEX_MODES`, `pickIcon`), session naming (`names.ts` with `generateUniqueSessionName` from 1600 adjective-noun pairs), audio notifications (`notification-sound.ts` with Web Audio E5→G5 chime synthesis), directory history (`recent-dirs.ts` with LRU cache of 5 entries in `localStorage`).

## Architecture

### Data Flow

Browser ←→ WebSocket `/ws/browser/:id` ←→ Hono server (:3456) ←→ NDJSON WebSocket `/ws/cli/:id` ←→ Claude Code CLI subprocess. `ws.ts` parses incoming NDJSON from CLI, dispatches to `store.ts` actions (`appendMessage`, `addPermission`, `setTasks`), components read via `useStore` selectors, user actions trigger `sendToSession` calls relayed back to CLI.

### State Synchronization

All session state keyed by `sessionId` in Zustand store. WebSocket handlers in `ws.ts` update store, components subscribe via `useStore((s) => s.messages.get(sessionId))`, sidebar polls `api.listSessions()` every 5000ms, merges server `SdkSessionInfo[]` into `sdkSessions` array, hydrates server-provided names replacing auto-generated `/^[A-Z][a-z]+ [A-Z][a-z]+$/` pattern via `markRecentlyRenamed`.

### Routing

Hash-based routing in `App.tsx` via `useHash` hook: `#/playground` → `Playground` component, default → main layout. Within main layout, `activeTab` state toggles between `ChatView` (combines `MessageFeed`, `Composer`, `PermissionBanner[]`) and `EditorPanel` (file tree + CodeMirror). `currentSessionId` determines whether to show `HomePage` or session-specific views.

### Permission Flow

CLI sends `control_request` with `subtype: "can_use_tool"` → `ws.ts` parses → `store.addPermission(sessionId, perm)` → `ChatView` renders `PermissionBanner` array → user clicks Allow/Deny → `PermissionBanner` sends `control_response` via `sendToSession` → `store.removePermission` clears from Map.

### Task Extraction

`ws.ts` calls `extractTasksFromBlocks` for all `assistant` and `permission_request` messages, parses `TodoWrite` (full replace), `TaskCreate` (incremental add with auto-numbered IDs), `TaskUpdate` (partial update by task ID), stores in `sessionTasks.get(sessionId)`, `TaskPanel` renders `TaskRow` with status icons (spinner/checkmark/circle) and `blockedBy` dependencies.

### Session Lifecycle

On mount, `App.tsx` reads `currentSessionId` from localStorage, calls `connectSession` → `ws.ts` opens WebSocket to `/ws/browser/:id` → server relays `session_init` with full `SessionState` → `store.addSession`, `setCliConnected(true)`, auto-generates name via `generateUniqueSessionName` if none exists → `ChatView` renders message history. Sidebar shows "Reconnect" button when `cliConnected === false`, calls `api.relaunchSession` which spawns CLI with `--resume`.

## Behavioral Contracts

### WebSocket Message Handling

- `session_init` → `addSession`, `setCliConnected(true)`, `setSessionStatus("idle")`, generate name if absent
- `assistant` → `appendMessage`, `extractTasksFromBlocks`, `extractChangedFilesFromBlocks`, set `streamingStartedAt`
- `stream_event` → accumulate `text_delta` in `streaming` Map, capture `output_tokens` from `message_delta`
- `result` → update cost/turns/context_used_percent, call `playNotificationSound()` if `!document.hasFocus() && notificationSound`, append system message on `is_error`
- `permission_request` → `addPermission`, construct synthetic `tool_use` block for task extraction
- `message_history` → replace messages if history length >= existing, extract tasks from all assistant messages

### Task Extraction Logic

- **TodoWrite**: expects `input.todos: Array<{content, status, activeForm}>`, calls `setTasks` with renumbered IDs starting from 1
- **TaskCreate**: increments `taskCounters[sessionId]`, builds `TaskItem` with `id=String(count)`, `subject=input.subject`, `status="pending"`, calls `addTask`
- **TaskUpdate**: extracts `taskId`, builds partial update with `status`, `owner`, `activeForm`, `blockedBy` (from `addBlockedBy`), calls `updateTask`
- Deduplication via `processedToolUseIds.get(sessionId)` Set, skips if `toolUseId` already processed

### LocalStorage Keys

- `cc-session-names` — JSON array of `[sessionId, name]` tuples
- `cc-current-session` — active session ID string
- `cc-dark-mode` — "true"/"false"
- `cc-notification-sound` — "true"/"false"
- `cc-recent-dirs` — JSON array of up to 5 directory paths

### Reconnection Strategy

- WebSocket close → `scheduleReconnect(sessionId)` after 2000ms
- Check if session archived in `sdkSessions` → skip if archived
- Call `connectSession(sessionId)` → clear existing reconnect timer on `onopen`

## File Relationships

`main.tsx` → `App.tsx` → `ChatView`/`EditorPanel`/`Sidebar`/`TaskPanel` (all from `components/`). `ws.ts` reads from `store.ts` via `useStore.getState()`, writes via actions (`appendMessage`, `addTask`, `setStreaming`). `api.ts` consumed by all components for session/filesystem/git/env operations. `types.ts` re-exports server types from `../server/session-types.js`, imported by `ws.ts`, `api.ts`, all components. `utils/` helpers imported by `components/`: `generateUniqueSessionName` by `Sidebar`/`HomePage`, `getModelsForBackend`/`getModesForBackend` by `TopBar`/`HomePage`, `playNotificationSound` by `ws.ts`, `getRecentDirs`/`addRecentDir` by `FolderPicker`.