<!-- Generated by agents-reverse-engineer -->

# companion

The Vibe Companion — a web UI that reverse-engineers the Claude Code CLI `--sdk-url` WebSocket protocol to provide browser-based control over multiple sessions with streaming, tool call visibility, permission management, and Codex backend support.

## Stack

**Runtime:** Bun 1.0+  
**Backend:** Hono 4.7 (port 3456, dual WebSocket+REST)  
**Frontend:** React 19 + Vite 6.3 (dev HMR on 5174, production from `dist/`)  
**State:** Zustand 5.0 client store, JSON file persistence (`$TMPDIR/vibe-sessions/`)  
**CLI:** Published as `the-vibe-companion` via `bunx`  
**Testing:** Vitest 4.0 with jsdom for React, Node.js for server  
**Isolation:** Git worktree per session (stored in `~/.companion/worktrees/`)

## Architecture

### Three-Layer Protocol Bridge

```
Browser React (:5174) ←WebSocket /ws/browser/:id→ Hono (:3456) ←WebSocket NDJSON /ws/cli/:id→ Claude CLI (--sdk-url)
                                                      ↓
                                          Codex app-server (stdio JSON-RPC 2.0)
```

Server discriminates by URL path: `/ws/cli/:id` upgrades to CLI backend socket (NDJSON), `/ws/browser/:id` upgrades to typed JSON frontend socket. `WsBridge` maintains per-session `SessionContext` with `messageHistory`, `pendingPermissions`, `state`, `codexAdapter`. Backend selection (`claude-code` vs `codex`) determined at session creation, drives `CliLauncher.launch()` branch (spawns `claude --sdk-url` or `codex app-server` with `CodexAdapter` stdio translator). All downstream routing backend-agnostic.

### Message Flow

User submits prompt → browser POST `/api/sessions/create` → server spawns CLI subprocess with `--sdk-url ws://localhost:3456/ws/cli/SESSION_ID` → CLI connects back → server bridges `SDKSystemMessage` (init), `SDKAssistantMessage`, `SDKPartialAssistantMessage` (stream_event), `SDKControlRequest` (can_use_tool) to browser as typed JSON → browser renders tool calls in `MessageBubble`, approval UI in `PermissionBanner` → user approves → server relays `SDKControlResponse` to CLI → CLI continues execution → server receives `SDKResultSuccess`/`SDKResultError` → broadcasts completion to browsers.

Codex flow: `item/started` → `stream_event`, `item/agentMessage/delta` → `assistant` with streaming content, `item/commandExecution/requestApproval` → `permission_request` (auto-approved for MCP/WebSearch per `CODEX_MAPPING.md`), `turn/completed` → `CLIResultMessage`.

## Contents

### Project Root

- [Makefile](./Makefile) — Defines `make dev` (delegates to `cd web && bun run dev`), declares `.PHONY` targets `build`, `start`.

- [package.json](./package.json) — Root monorepo config with `name: "the-vibe-companion"`, `version: "0.17.1"`, `private: true`, scripts delegating to `web/` subdirectory (`dev`, `build`, `start`), `prepare` script running `husky` for git hooks, devDependencies `husky@9.1.7`.

- [README.md](./README.md) — User-facing quickstart documenting `bunx the-vibe-companion` command, architecture ASCII diagram with WebSocket endpoints (`/ws/cli/:session`, `/ws/browser/:session`), six core features (multi-session, streaming, tool visibility, subagent nesting, permission modes, `--resume` recovery), environment profiles in `~/.companion/envs/`, tech stack (Bun, Hono, React 19, Zustand, Tailwind v4), dev commands (`bun run dev` for backend+Vite HMR on 5174, `bun run build && bun run start` for production), MIT license, GitHub repo link `The-Vibe-Company/companion`.

- [WEBSOCKET_PROTOCOL_REVERSED.md](./WEBSOCKET_PROTOCOL_REVERSED.md) — Comprehensive reverse-engineering spec for Claude Code CLI v2.1.37 `--sdk-url` protocol. Documents NDJSON-over-WebSocket transport, launch flags (`--sdk-url`, `--print`, `--output-format stream-json`), six transport classes (`ProcessInputTransport`, `SdkUrlTransport`, `WebSocketTransport`, `HybridTransport`, `SessionsWS`, `RemoteSessionMgr`, `DirectConnectWebSocket`), connection lifecycle (init → `control_request/initialize` → `user` messages → multi-turn), 15+ message types (`SDKSystemMessage`, `SDKAssistantMessage`, `SDKPartialAssistantMessage`, `SDKResultSuccess`, `SDKControlRequest`, `SDKToolProgressMessage`, `SDKHookStartedMessage`, `SDKFilesPersistedEvent`), 13 control subtypes (`initialize`, `can_use_tool`, `interrupt`, `set_permission_mode`, `set_model`, `mcp_status`, `mcp_message`, `mcp_reconnect`, `mcp_toggle`, `mcp_set_servers`, `rewind_files`, `hook_callback`), three-layer permission pipeline (PreToolUse hooks → local rule eval → remote `can_use_tool`), six PermissionMode values (`default`, `acceptEdits`, `bypassPermissions`, `plan`, `delegate`, `dontAsk`), reconnection resilience (max 3 WS attempts with exponential backoff base 1s/max 30s, ping interval 10s, circular buffer capacity 1000, HybridTransport max 10 POST retries), environment variables (`CLAUDE_CODE_SESSION_ACCESS_TOKEN`, `CLAUDE_CODE_POST_FOR_SESSION_INGRESS_V2`), ContentBlock types (text, tool_use, tool_result, thinking), HookEvent types (PreToolUse, PostToolUse, PermissionRequest, SessionStart, TeammateIdle, TaskCompleted).

## Subdirectories

- [scripts/](./scripts/) — Shell utilities for dev environment lifecycle: `dev-start.sh` orchestrates backend (port 3456) and Vite (port 5174) with PID tracking (`.dev-backend.pid`, `.dev-vite.pid`), HTTP health polling (`curl --max-time 3`, 60s max wait, 1s interval), accepts `--start`/`--stop`/`--status` commands, invoked by `make dev`.

- [web/](./web/) — Full-stack application root with Bun+Hono backend (`server/` subdirectory: `ws-bridge.ts` message router, `cli-launcher.ts` subprocess manager, `codex-adapter.ts` JSON-RPC translator, `session-store.ts` file persistence, `git-utils.ts`/`worktree-tracker.ts` isolation, `env-manager.ts` environment profiles, `auto-namer.ts` LLM titling, `routes.ts` REST API), React 19 frontend (`src/` subdirectory: `App.tsx` root layout with hash routing, `store.ts` Zustand session state, `ws.ts` WebSocket client with NDJSON parsing, `api.ts` REST client, `components/` with ChatView, MessageFeed, Composer, Sidebar, TaskPanel, ToolBlock, EditorPanel, Playground, EnvManager), CLI entry point (`bin/cli.ts` setting `__VIBE_PACKAGE_ROOT`), config files (`package.json` bin entry, `vite.config.ts` proxy to 3456, `vitest.config.ts` environmentMatchGlobs), protocol mapping spec (`CODEX_MAPPING.md` for Codex JSON-RPC 2.0 translation).

## Data Flow

1. User runs `bunx the-vibe-companion` → `web/bin/cli.ts` imports `web/server/index.ts`
2. Server starts Hono on 3456, serves `web/dist/` in production or proxies Vite in dev
3. Browser loads React app, renders `HomePage` with session list from `GET /api/sessions`
4. User creates session with backend selection → `POST /api/sessions/create` → `CliLauncher.launch()` spawns subprocess
5. CLI connects to `/ws/cli/:id` → `WsBridge.handleCLIConnect()` upgrades socket, stores in `SessionContext.cliSocket`
6. Browser connects to `/ws/browser/:id` → `WsBridge.handleBrowserConnect()` stores in `browserSockets` Set
7. User sends prompt → `ws.ts` sends `{type: "user", message}` → `WsBridge` relays to CLI socket (Claude) or `codexAdapter.sendMessage()` (Codex)
8. CLI streams responses → `WsBridge.handleCLIMessage()` parses NDJSON → broadcasts to all `browserSockets`
9. Tool calls trigger `control_request` → stored in `pendingPermissions` Map → browser renders `PermissionBanner` → user approves → `control_response` relayed
10. Turn completes → `result` message → `auto-namer.ts` generates title (first turn only) → `SessionNames.setName()` persists → browser receives update
11. `SessionStore` debounces writes (150ms for stream events) to `$TMPDIR/vibe-sessions/{id}.json`

## Session Persistence

`SessionStore.save()` debounces writes to JSON files (150ms default, immediate via `saveSync()` for critical state). Persisted fields: `id`, `state` (model, cwd, tools, permissionMode, git_branch, cost, context), `messageHistory` (full `BrowserIncomingMessage[]`), `pendingMessages` (queued while CLI disconnected), `pendingPermissions` (Map serialized to array). On server restart, `WsBridge.restoreFromDisk()` rehydrates `sessions` Map, `CliLauncher.restoreFromDisk()` detects stale PIDs via `kill -0` check, waits 10s grace period for reconnect, relaunches with `--resume <cliSessionId>` for Claude backend or fresh `CodexAdapter` for Codex backend.

## Git Worktree Isolation

`git-utils.ts` `ensureWorktree(repoRoot, branch)` creates unique paths at `~/.companion/worktrees/{repoName}/{sanitizedBranch}`, generates `-wt-{random4digit}` suffixes for concurrent sessions on same branch. `WorktreeTracker` persists session-to-worktree mappings at `~/.companion/worktrees.json`. `CliLauncher.launch()` injects markdown guardrails into `.claude/CLAUDE.md` when `worktreeInfo` provided, forbidding `git checkout/switch`, enforcing commits to current branch. Routes expose `POST /api/git/worktree`, `DELETE /api/git/worktree` with safety checks via `isWorktreeInUse()` preventing deletion of shared worktrees.

## Environment Profiles

`EnvManager` stores named variable sets at `~/.companion/envs/{slug}.json` with interface `{name, slug, variables: Record<string,string>, createdAt, updatedAt}`. Slug generation via `slugify()`: lowercase, replace whitespace with hyphens, strip non-alphanumeric. REST API: `GET /envs`, `POST /envs`, `PUT /envs/:slug`, `DELETE /envs/:slug`. `HomePage` renders `EnvManager` modal with key-value editor consuming `api.listEnvs()`, `api.createEnv()`.

## Task Extraction

`ws.ts` parses `assistant` messages for `tool_use` blocks named `TodoWrite`, `TaskCreate`, `TaskUpdate`. `extractTasksFromBlocks()` logic: `TodoWrite` replaces entire list (renumbered from 1), `TaskCreate` increments counter, `TaskUpdate` applies partial update (status, owner, activeForm, blockedBy). Deduplicates via `processedToolUseIds` Map. `TaskPanel` subscribes to `sessionTasks.get(sessionId)`, renders `TaskRow` with status icons (spinner/checkmark/circle).

## Auto-Naming Pipeline

On session creation, `WsBridge` registers callback invoking `auto-namer.ts` after first completed turn. `generateSessionTitle()` extracts first 500 chars of user message, spawns one-shot CLI: `claude -p PROMPT --model MODEL --output-format json` (parses `result` field) for Claude backend, `codex exec -q PROMPT --model MODEL --json` (parses JSONL for last `agentMessage` item) for Codex backend. Strips quotes via `/^["']|["']$/g`, validates length < 100, persists via `SessionNames.setName()`, broadcasts update to browsers. 15s timeout, logged warnings on failure.

## Behavioral Contracts

### NDJSON Protocol

CLI processes write newline-delimited JSON to WebSocket. `WsBridge.handleCLIMessage()` splits `data` on `\n`, parses each line via `JSON.parse()`. Codex adapter uses identical newline-delimited JSON-RPC over stdin/stdout via `JsonRpcTransport.send()` (appends `\n`), `.onData()` (splits on `\n`). Browser WebSockets receive typed JSON messages without delimiters.

### Git Command Patterns

All git operations in `git-utils.ts` use `execSync` with `timeout: 10_000` ms:
- `git rev-parse --abbrev-ref HEAD` → current branch
- `git rev-parse --show-toplevel` → repo root
- `git rev-parse --git-dir` → worktree detection (checks `/worktrees/` substring)
- `git worktree list --porcelain` → parses lines prefixed `worktree `, `HEAD `, `branch `
- `git worktree add -b {branch} "{path}" {base}` → create worktree
- `git rev-list --left-right --count origin/{branch}...{branch}` → ahead/behind counts

Worktree paths sanitized via `sanitizeBranchName()`: replace `/` with `_`, collapse multiple underscores.

### Auto-Naming Prompt Template

```
Generate a concise 3-5 word session title for this user request. Output ONLY the title, nothing else.

Request: ${first500chars}
```

Claude backend: `claude -p PROMPT --model MODEL --output-format json`, extracts `parsed.result`.  
Codex backend: `codex exec -q PROMPT --model MODEL --json`, parses JSONL for last `item.type === "agentMessage"` with `item.completed`, extracts `item.text`.

### Permission Request Flow

Claude Code: CLI sends `control_request` (subtype `can_use_tool`) → WsBridge stores in `pendingPermissions` Map → broadcasts `permission_request` to browsers → user responds → WsBridge sends `control_response` (behavior `"allow"` or `"deny"`).

Codex: adapter receives `item/commandExecution/requestApproval` or `item/fileChange/requestApproval` JSON-RPC request → stores request ID → synthesizes `permission_request` → user responds → sends JSON-RPC response `{decision: "accept" | "decline"}`.

### WebSocket Reconnection

Browser: `ws.ts` registers `onclose` handler calling `scheduleReconnect(sessionId)` after 2000ms. Checks if session archived in `sdkSessions` before reconnecting. Clears timeout on `onopen`.

CLI: On disconnect, WsBridge stores pending messages in `pendingMessages[]`, waits 10s grace period. If CLI reconnects (server restart case), replays queue. If timeout expires, `CliLauncher.relaunchSession()` kills stale PID, spawns with `--resume <cliSessionId>`.

### Context Usage Calculation

Extracted from `result` messages: `Math.round(((inputTokens + outputTokens) / contextWindow) * 100)` clamped to `[0, 100]`. Reads `msg.modelUsage[model].inputTokens`, `msg.modelUsage[model].outputTokens`, `msg.modelUsage[model].modelContextWindow`.

## Development Commands

```bash
# Dev server (Hono backend on :3456 + Vite HMR on :5174)
cd web && bun install && bun run dev
# Or from repo root
make dev

# Type checking
cd web && bun run typecheck

# Production build + serve
cd web && bun run build && bun run start

# Tests (with watch mode)
cd web && bun run test
cd web && bun run test:watch
```

**Testing Requirements:** All new backend (`web/server/`) and frontend (`web/src/`) code must include tests. Vitest tests live alongside source files. Husky pre-commit hook runs typecheck and tests automatically. Existing tests must never be removed without explicit user approval.

## File Relationships

`Makefile` delegates to `web/package.json` scripts. `web/dev.ts` spawns `web/server/index.ts` and Vite in parallel. `web/bin/cli.ts` imports `web/server/index.ts` for production execution. `web/server/index.ts` wires together `WsBridge`, `CliLauncher`, `SessionStore`, `WorktreeTracker`, registers routes from `routes.ts`, serves `web/dist/` when `NODE_ENV=production`. `web/server/ws-bridge.ts` delegates subprocess lifecycle to `cli-launcher.ts`, message translation to `codex-adapter.ts`, persistence to `session-store.ts`. `web/src/App.tsx` imports `ws.ts` for WebSocket management, `api.ts` for REST calls, `store.ts` for state subscriptions. All components in `web/src/components/` consume `store.ts` via `useStore` selectors, call `api.ts` functions, send messages via `sendToSession` from `ws.ts`. `web/src/types.ts` re-exports `web/server/session-types.ts` for shared protocol definitions across client and server.